# Implementation Plan

## Task 1: プロジェクト基盤セットアップ
- [x] 1.1 開発環境とプロジェクト構造の初期化
  - Node.js プロジェクトの初期化と TypeScript 設定
  - ESLint、Prettier による開発ツールチェーン構築
  - Docker Compose による PostgreSQL、Redis のローカル環境構築
  - モジュラーモノリス構造のディレクトリ作成（Book, Loan, User, Reservation, Report の5ドメイン）
  - _Requirements: 1.5, 2.1, 3.1, 4.1, 5.1, 6.1, 7.1_

- [x] 1.2 データベーススキーマとマイグレーション基盤
  - PostgreSQL 接続設定とコネクションプール構築
  - Book、BookCopy、User、Loan、Reservation、OverdueRecord テーブルのマイグレーション作成
  - ISBN ユニーク制約、外部キー制約の設定
  - 全文検索用 GIN インデックスの設定（タイトル、著者）
  - _Requirements: 1.5, 2.1, 3.1, 4.1, 5.4, 6.1, 7.1_

- [x] 1.3 共通基盤モジュールの実装
  - [x] Branded Types（BookId, UserId, LoanId, ReservationId, CopyId）の定義
  - [x] Result<T, E> パターンによるエラーハンドリングユーティリティ
  - [x] 共通バリデーション機能（ISBN形式、必須項目チェック）
  - _Requirements: 1.4, 5.5_

## Task 2: 蔵書管理機能（Book ドメイン）
- [x] 2.1 (P) 書籍マスタの CRUD 機能実装
  - 書籍の登録機能（タイトル、著者、出版社、出版年、ISBN、カテゴリ）
  - 必須項目バリデーション（タイトル、著者、ISBN）
  - ISBN 重複チェックとエラー応答
  - 書籍情報の編集機能と更新日時記録
  - 書籍削除時の確認ロジックと削除処理
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_

- [x] 2.2 (P) 蔵書コピー管理機能の実装
  - 物理的な蔵書コピーの登録（所在場所、状態管理）
  - 蔵書コピーの状態更新機能（貸出可能、貸出中、予約済み、メンテナンス）
  - 書籍マスタに紐づく蔵書コピー一覧取得
  - _Requirements: 1.1, 1.5, 3.5_

- [x] 2.3 蔵書管理 REST API エンドポイント
  - POST /api/books - 書籍登録
  - PUT /api/books/:id - 書籍編集
  - DELETE /api/books/:id - 書籍削除
  - GET /api/books/:id - 書籍詳細取得
  - POST /api/books/:id/copies - 蔵書コピー登録
  - エラーレスポンス形式の統一（400, 404, 409）
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_

## Task 3: 蔵書検索機能
- [x] 3.1 検索サービスの実装
  - タイトル、著者、ISBN、カテゴリによる部分一致検索
  - PostgreSQL 全文検索機能を活用した高速検索
  - 検索結果のソート機能（タイトル順、著者順、出版年順）
  - 検索結果が0件の場合の適切なレスポンス
  - _Requirements: 2.1, 2.2, 2.5_

- [x] 3.2 詳細検索とフィルタリング機能
  - 出版年範囲による絞り込み
  - カテゴリによるフィルタリング
  - 貸出可能書籍のみの絞り込み
  - 複合条件での検索実行
  - _Requirements: 2.4_

- [x] 3.3 検索 REST API エンドポイント
  - GET /api/books/search - 検索実行（クエリパラメータ対応）
  - GET /api/books/:id - 書籍詳細と貸出状況表示
  - ページネーション対応
  - _Requirements: 2.1, 2.3_

## Task 4: 利用者管理機能（User ドメイン）
- [x] 4.1 (P) 利用者 CRUD 機能実装
  - 利用者登録と一意の利用者ID発行
  - 利用者情報管理（氏名、住所、連絡先、登録日）
  - 利用者ID重複チェック
  - 利用者の貸出上限設定
  - _Requirements: 5.1, 5.4, 5.5_

- [x] 4.2 (P) 利用者検索・照会機能
  - 氏名、利用者ID、連絡先による利用者検索
  - 利用者詳細表示（現在の貸出状況、貸出履歴）
  - _Requirements: 5.2, 5.3_

- [x] 4.3 利用者管理 REST API エンドポイント
  - POST /api/users - 利用者登録
  - GET /api/users/:id - 利用者詳細取得
  - GET /api/users/search - 利用者検索
  - GET /api/users/:id/loans - 利用者の貸出履歴
  - _Requirements: 5.1, 5.2, 5.3_

## Task 5: 貸出管理機能（Loan ドメイン）
- [x] 5.1 貸出処理サービスの実装
  - 利用者IDと書籍IDによる貸出処理
  - 貸出可否の検証（蔵書状態チェック）
  - 利用者の貸出上限チェックと警告
  - 返却期限の自動設定
  - 貸出記録の作成と蔵書状態の更新
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [x] 5.2 貸出レシート発行機能
  - 貸出完了時のレシート情報生成
  - 返却期限、書籍情報、利用者情報の出力
  - _Requirements: 3.2_

- [x] 5.3 貸出状況表示機能
  - 検索結果への貸出中ステータス表示
  - 蔵書コピーごとの現在状態取得
  - _Requirements: 3.5_

- [x] 5.4 貸出管理 REST API エンドポイント
  - POST /api/loans - 貸出処理
  - GET /api/loans/:id - 貸出詳細
  - 適切なエラーレスポンス（貸出不可、上限超過）
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

## Task 6: 返却管理機能
- [x] 6.1 返却処理サービスの実装
  - 書籍IDによる返却処理
  - 貸出記録の更新と返却日記録
  - 蔵書状態の「貸出可能」への更新
  - _Requirements: 4.1, 4.2_

- [x] 6.2 延滞判定と記録機能
  - 返却期限超過の判定
  - 延滞日数の計算
  - 延滞情報の表示
  - 延滞記録の利用者履歴への保存
  - _Requirements: 4.3, 4.4_

- [x] 6.3 返却管理 REST API エンドポイント
  - POST /api/loans/:id/return - 返却処理
  - 延滞情報を含むレスポンス
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

## Task 7: 予約機能（Reservation ドメイン）
- [ ] 7.1 予約サービスの実装
  - 貸出中書籍への予約リクエスト処理
  - 予約番号の発行
  - 予約キューの FIFO 管理
  - 同一書籍への重複予約チェック
  - _Requirements: 6.1, 6.3_

- [ ] 7.2 予約状態管理機能
  - 予約書籍返却時の自動検知
  - 予約者への通知トリガー
  - 予約有効期限の管理（7日間）
  - 期限切れ予約のキャンセルと次順位者への通知
  - _Requirements: 6.2, 6.4_

- [ ] 7.3 予約 REST API エンドポイント
  - POST /api/reservations - 予約作成
  - DELETE /api/reservations/:id - 予約キャンセル
  - GET /api/users/:id/reservations - 利用者の予約一覧
  - _Requirements: 6.1, 6.2, 6.3, 6.4_

## Task 8: 通知機能
- [ ] 8.1 非同期通知キューの実装
  - Redis + BullMQ によるジョブキュー構築
  - 通知ジョブの登録と処理
  - 送信失敗時のリトライ機能（最大3回）
  - _Requirements: 6.2, 6.4_

- [ ] 8.2 メール通知機能の実装
  - 予約書籍の貸出可能通知
  - 通知履歴の記録
  - _Requirements: 6.2, 6.4_

## Task 9: レポート・統計機能（Report ドメイン）
- [ ] 9.1 (P) 統計データ集計サービス
  - 貸出数、返却数、延滞数の集計
  - 期間指定による統計生成
  - 人気書籍ランキング算出
  - カテゴリ別貸出統計
  - _Requirements: 7.1, 7.2, 7.3_

- [ ] 9.2 (P) レポート出力機能
  - グラフ・表形式でのデータ整形
  - CSV エクスポート機能
  - _Requirements: 7.2, 7.4_

- [ ] 9.3 レポート REST API エンドポイント
  - GET /api/reports/summary - 統計サマリー
  - GET /api/reports/loans - 貸出統計（期間指定）
  - GET /api/reports/popular - 人気書籍ランキング
  - GET /api/reports/export - CSV エクスポート
  - _Requirements: 7.1, 7.2, 7.3, 7.4_

## Task 10: フロントエンド基盤
- [ ] 10.1 React プロジェクトセットアップ
  - Vite + React + TypeScript プロジェクト初期化
  - ルーティング設定（React Router）
  - API クライアント基盤の構築
  - 認証状態管理の基盤
  - _Requirements: 1.1, 2.1, 3.1, 5.1_

- [ ] 10.2 共通 UI コンポーネント
  - フォーム入力コンポーネント（バリデーション付き）
  - テーブル・リスト表示コンポーネント
  - 確認ダイアログコンポーネント
  - 通知・アラートコンポーネント
  - _Requirements: 1.3, 3.2_

## Task 11: フロントエンド機能実装
- [ ] 11.1 (P) 蔵書管理画面
  - 書籍登録フォーム（必須項目バリデーション）
  - 書籍一覧・編集・削除画面
  - 削除確認ダイアログ
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [ ] 11.2 (P) 蔵書検索画面
  - 検索フォーム（キーワード入力）
  - 検索結果一覧表示
  - 詳細検索オプション（出版年、カテゴリ、貸出可能のみ）
  - ソート機能（タイトル、著者、出版年）
  - 書籍詳細・貸出状況表示
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5_

- [ ] 11.3 (P) 貸出・返却処理画面
  - 貸出フォーム（利用者ID、書籍ID入力）
  - 貸出レシート表示
  - 返却処理フォーム
  - 延滞情報表示
  - エラー表示（貸出不可、上限超過）
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 4.1, 4.2, 4.3_

- [ ] 11.4 (P) 利用者管理画面
  - 利用者登録フォーム
  - 利用者検索・一覧
  - 利用者詳細（貸出状況、履歴）
  - _Requirements: 5.1, 5.2, 5.3, 5.4_

- [ ] 11.5 (P) 予約画面
  - 予約リクエストフォーム
  - 予約状況一覧
  - 予約キャンセル機能
  - _Requirements: 6.1, 6.3_

- [ ] 11.6 (P) レポート・統計画面
  - 統計サマリーダッシュボード
  - 期間指定レポート生成
  - グラフ・表形式表示
  - CSV ダウンロード機能
  - _Requirements: 7.1, 7.2, 7.3, 7.4_

## Task 12: 認証・認可機能
- [ ] 12.1 セッション認証の実装
  - Redis セッションストアの構築
  - ログイン・ログアウト機能
  - セッション有効期限管理
  - _Requirements: 3.1, 5.1_

- [ ] 12.2 ロールベースアクセス制御
  - 図書館員、利用者、管理者ロールの定義
  - エンドポイントごとの権限チェック
  - 権限不足時のエラーレスポンス
  - _Requirements: 1.1, 3.1, 5.1, 7.1_

## Task 13: 統合とセキュリティ
- [ ] 13.1 API セキュリティ対策
  - 入力バリデーションの網羅的実装
  - パラメータ化クエリによる SQL インジェクション対策
  - CSP ヘッダー設定
  - _Requirements: 1.4, 5.5_

- [ ] 13.2 エンドツーエンド統合テスト
  - 図書館員フロー: 蔵書登録 → 検索 → 貸出 → 返却
  - 利用者フロー: 検索 → 詳細表示 → 予約
  - 管理者フロー: レポート表示 → CSV 出力
  - _Requirements: 1.1, 2.1, 3.1, 4.1, 6.1, 7.1_

## Task 14: 単体・統合テスト
- [ ]* 14.1 ドメインサービス単体テスト
  - BookService: ISBN バリデーション、CRUD 操作テスト
  - LoanService: 貸出可否判定、延滞計算テスト
  - ReservationService: 予約キュー順序、有効期限判定テスト
  - SearchService: 検索クエリ構築、ソート処理テスト
  - _Requirements: 1.1, 1.4, 2.1, 2.5, 3.1, 3.3, 3.4, 4.3, 6.1, 6.4_

- [ ]* 14.2 統合テスト
  - 貸出フロー統合テスト（利用者認証 → 書籍確認 → 貸出作成 → 状態更新）
  - 返却フロー統合テスト（返却処理 → 延滞判定 → 予約通知トリガー）
  - 予約フロー統合テスト（予約作成 → 返却検知 → 通知送信）
  - _Requirements: 3.1, 3.2, 4.1, 4.4, 6.2, 6.4_
